version: 2.1
orbs: 
  rememborb: circleci/rememborb@0.0.2
jobs:
  publish_image:
    docker:
      - image: cimg/base:stable
    steps:
      - rememborb/remember:
          env_var: REPO_VERSION
          value: 'super_cool_image:1.0.$CIRCLE_BUILD_NUM-$CIRCLE_PROJECT_USERNAME'
      #- run: docker build -t $IMAGE_TAG .
      #- run: docker push $IMAGE_TAG
  test_image:
    docker:
      - image: cimg/base:stable
    steps:
      - rememborb/recall:
          env_var: REPO_VERSION
      - run: echo $REPO_VERSION
      #- run: docker run $IMAGE_TAG test_coolness
  deploy_image:
    docker:
      - image: cimg/base:stable
    steps:
      - rememborb/recall:
          env_var: REPO_VERSION
      - run: echo $REPO_VERSION
      - run: echo "This is the env repo:" $REPO_VERSION
workflows:
  highly_fault_tolerant_delivery:
    jobs:
      - publish_image
      - test_image:
          requires:
            - publish_image
      - deploy_image:
          requires:
            - test_image
