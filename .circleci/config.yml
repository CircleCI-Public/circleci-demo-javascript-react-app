version: 2.1

orbs: 
  node: circleci/node@5.0.0

jobs: 
#tier1
  check-if-pr-is-ready:
    executor: 
      name: node/default
    steps:
      - run: 
          command: | 
            sleep 2

  lint:
    executor: 
      name: node/default
    steps:
      - run: 
          command: | 
            sleep 2

#tier2
  static-analysis: 
    executor: 
      name: node/default
    working_directory: ~/project
    steps:
      - run: 
          command: | 
            sleep 2          

  linux: 
    executor: 
      name: node/default
    steps:
      - checkout   
      - run: 
          command: | 
            sleep 2    
      - run: 
          command: | 
            curl --request GET --url https://circleci.com/api/v2/workflow/$CIRCLE_WORKFLOW_ID/job --header 'Circle-Token: $CIRCLE_TOKEN' | jq > jobsInWorkflow.json
            cat jobsInWorkflow.json
      # - run: 
      #     command: | 
      #       curl -X POST --header "Content-Type: application/json" "https://circleci.com/api/v2/project/gh/jkzilla/circleci-demo-javascript-react-app/job/${CIRCLE_BUILD_NUM}/cancel?circle-token=${CIRCLE_TOKEN}" 
      - persist_to_workspace:
          root: .
          paths:
            - "*"
  compute-high-level-metrics: 
    executor: 
      name: node/default
    steps:
      - run: 
          command: | 
            sleep 2
            curl -X POST --header "Content-Type: application/json" "https://circleci.com/api/v2/project/gh/jkzilla/circleci-demo-javascript-react-app/job/${CIRCLE_BUILD_NUM}/cancel?circle-token=${CIRCLE_TOKEN}" 
  compute-low-level-metrics: 
    executor: 
      name: node/default
    steps:
      - attach_workspace:
          at: .
      - run: 
          command: | 
            pwd
            ls
            cat jobsInWorkflow.json
            # cd ~/project
            # cat jobsInWorkflow.json
            sleep 2
  build-template: 
    executor: 
      name: node/default
    steps:
      - run: 
          command: | 
            sleep 2
      - run:
          command: |
            curl -X POST --header "Content-Type: application/json" "https://circleci.com/api/v2/project/gh/jkzilla/circleci-demo-javascript-react-app/job/${CIRCLE_BUILD_NUM}/cancel?circle-token=${CIRCLE_TOKEN}" 

workflows:
  default:
    jobs:
      - check-if-pr-is-ready
      - lint
      - static-analysis:
          requires: [ 'check-if-pr-is-ready' ]
          context: 
            - CIRCLE_TOKEN
      - linux:
          requires: [ 'check-if-pr-is-ready' ]
      - compute-high-level-metrics:
          requires: [ 'linux' ]
          context: 
            - CIRCLE_TOKEN
      - compute-low-level-metrics:
          requires:
            - linux
      - build-template:
          requires: [ 'check-if-pr-is-ready' ]
          context: 
            - CIRCLE_TOKEN          