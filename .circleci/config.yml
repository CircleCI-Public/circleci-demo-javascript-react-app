version: 2.1
setup: true

parameters:
  browser:
    type: string
    default: ${DEFAULT_BROWSER}
  desktop:
    type: string
    default: "false"
  parallelism:
    description: "Number of containers to run in parallel"
    type: integer
    default: 10
  run_accessibility:
    type: boolean
    default: false
  run_deploy:
    type: boolean
    default: false
  run_manual_build:
    type: boolean
    default: false
  run_smokes:
    type: boolean
    default: false
  target_env:
    description: "Demo Environment to trigger the smoke tests against"
    type: string
    default: ${TARGET_ENV}
  test_path:
    description: "Path to test folder, or specific test file"
    type: string
    default: ./tests/**/*.js

orbs:
  continuation: circleci/continuation@0.2.0

jobs:
  generate-regressions-config:
    executor: continuation/default
    steps:
      - checkout 
      - run:
          name: Trying to set a dynamic pipeline var
          command: |
            echo 'export RUN_DEPLOY=<< pipeline.parameters.run_deploy >>' >> $BASH_ENV # just an example, hash will be generated based on more complex logic
            touch parameters.json
            echo '{"run_deploy": ${RUN_DEPLOY}}' > parameters.json
            cat parameters.json
      - continuation/continue:
          configuration_path: ./regressions_config.yml
          parameters: ./parameters.json

  generate-smokes-config:
    executor: continuation/default
    steps:
      - checkout
      - continuation/continue:
          configuration_path: ./smokes_config.yml
workflows:
  setup-regression_run:
    unless: << pipeline.parameters.run_smokes >>
    jobs:
      - generate-regressions-config
  setup-smokes_run:
    when: << pipeline.parameters.run_smokes >>
    jobs:
      - generate-smokes-config
