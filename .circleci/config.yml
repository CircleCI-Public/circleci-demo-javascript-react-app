version: 2.1

orbs:
  continuation: circleci/continuation@0.3.1
  
setup: true

commands:
  check-pr:
    description: "Run API depending on branch"
    parameters:
      head:
        type: string
      base:
        type: string
      run:
        type: string
    steps:
      - when: 
          condition:
            equal: [ << parameters.head >>, << pipeline.git.branch >> ]
          steps: 
            - run:
                name: Check Pull Request from << parameters.head >> to << parameters.base >>
                command: |
                  if [ -n $CIRCLE_PULL_REQUEST ]; then
                    pr=$(echo https://api.github.com/repos/${CIRCLE_PULL_REQUEST:19} | sed "s/\/pull\//\/pulls\//")

                    base=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" $pr | jq '.base.ref')

                    if [[ '"<< parameters.base >>"' = "$base" ]]; then
                      << parameters.run >>
                    fi
                  fi

jobs:
  build:
    docker:
      - image: cimg/node:edge
    steps: 
      - check-pr:
          base: staging
          head: dev
          run: |
              echo "hello world!"
              # implement features here!

workflows:
  workflow1:
    jobs:
      - build