version: 2.1
orbs: 
  rememborb: circleci/rememborb@0.0.2
jobs:
  publish_image:
    docker:
      - image: 'circleci/python:3.7'
    steps:
      - mem/remember:
          env_var: IMAGE_TAG
          value: 'super_cool_image:1.0.$CIRCLE_BUILD_NUM-$CIRCLE_SHA'
      - run: docker build -t $IMAGE_TAG .
      - run: docker push $IMAGE_TAG
  test_image:
    docker:
      - image: 'circleci/python:3.7'
    steps:
      - mem/recall:
          env_var: IMAGE_TAG
      - run: docker pull $IMAGE_TAG
      - run: docker run $IMAGE_TAG test_coolness
  deploy_image:
    docker:
      - image: 'circleci/python:3.7'
    steps:
      - mem/recall:
          env_var: IMAGE_TAG
      - run: docker pull $IMAGE_TAG
      - run: some_kubernetes_shenanigans $IMAGE_TAG
workflows:
  highly_fault_tolerant_delivery:
    jobs:
      - publish_image
      - test_image:
          requires:
            - publish_image
      - deploy_image:
          requires:
            - test_image
