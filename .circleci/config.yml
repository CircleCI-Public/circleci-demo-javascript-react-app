version: 2.1

only-deploy-tags: &only-deploy-tags
  filters:
    tags:
      only: /.*/
    branches:
      ignore: /.*/

parameters:
  run_git_tag:
    type: string
    default: << pipeline.git.tag >>

jobs:
  default_tests:
    macos:
      xcode: 13.1.0
    shell: /bin/bash --login -eo pipefail
    environment:
      - TZ: Europe/Brussels
    steps:
      - checkout
  default_build_and_deploy:
    macos:
      xcode: 13.1.0
    shell: /bin/bash --login -eo pipefail
    environment:
      - TZ: Europe/Brussels
    steps:
      - checkout

# Followed example https://github.com/halfer/cd-demo-container/blob/master/.circleci/config.yml
workflows:
  version: 2
  # This runs on non-tag pushes
  untagged-build:
    jobs:
      - default_tests:
        filters:
          tags:
            ignore: /.*/
  # This only runs on deploy tags and not branches https://discuss.circleci.com/t/how-to-force-run-a-periodic-workflow/28647/3
  tagged-build:
    when: << pipeline.parameter.gitTag >>
    jobs:
      - default_tests
      - default_build_and_deploy:
          requires:
            - default_tests
            